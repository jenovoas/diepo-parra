datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  role          String    @default("USER") // USER, ADMIN, DOCTOR, ASSISTANT
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  patient                  Patient?
  accounts                 Account[]
  sessions                 Session[]
  doctorAppointments       Appointment[] @relation("DoctorAppointments")
  professionalSignatures   ProfessionalSignature[]
}

model Patient {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal Info
  fullName   String
  phone      String?
  birthDate  DateTime
  occupation String?
  address    String?
  gender     String?

  // Additional Medical Info
  bloodType         String? // A+, B-, O+, etc.
  allergies         String? // JSON array of allergies (encrypted)
  chronicConditions String? // JSON array of chronic conditions (encrypted)
  emergencyContact  String? // JSON object with name, phone, relationship (encrypted)
  insuranceInfo     String? // JSON object with insurance details (encrypted)

  // Medical Data (Sensitive - will be encrypted)
  condition           String? // Encrypted
  anamnesis           String? // Encrypted
  surgicalHistory     String? // Encrypted
  pathologicalHistory String? // Encrypted
  diagnosis           String? // Encrypted
  treatmentPlan       String? // Encrypted
  evolutionNotes      String? // Encrypted

  // Privacy & Consent (Chilean Law 19.628 compliance)
  consentMedical        Boolean  @default(false)
  consentContact        Boolean  @default(false)
  consentDataProcessing Boolean  @default(false) // Art. 4 Ley 19.628
  consentDate           DateTime @default(now())
  consentUpdatedAt      DateTime @updatedAt

  // Soft Delete (Ley 19.628 Art. 14 - Derecho de Cancelación)
  deletedAt DateTime?
  deletedBy String? // User ID who deleted

  // Relations
  appointments      Appointment[]
  medications       Medication[]
  treatments        MedicalTreatment[]
  healthMetrics     HealthMetric[]
  deviceConnections HealthDeviceConnection[]
  auditLogs         AuditLog[]
  invoices          Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Medication tracking
model Medication {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  name         String
  dosage       String
  frequency    String
  startDate    DateTime
  endDate      DateTime?
  prescribedBy String? // Doctor name
  notes        String? // Encrypted
  isActive     Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Medical treatments (physiotherapy, acupuncture, etc.)
model MedicalTreatment {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  type        String // PHYSIOTHERAPY, ACUPUNCTURE, etc.
  description String?
  frequency   String? // e.g., "2 times per week"
  provider    String? // Clinic or professional name
  startDate   DateTime
  endDate     DateTime?
  progress    String? // JSON with progress notes (encrypted)
  isActive    Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Health metrics from devices or manual entry
model HealthMetric {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  type       String // STEPS, HEART_RATE, SLEEP, WEIGHT, BLOOD_PRESSURE, etc.
  value      Float
  unit       String // steps, bpm, hours, kg, mmHg, etc.
  source     String // APPLE_HEALTH, GOOGLE_FIT, FITBIT, MANUAL
  recordedAt DateTime
  notes      String?

  createdAt DateTime @default(now())
}

// Health device connections (Apple Health, Google Fit, etc.)
model HealthDeviceConnection {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  provider     String // APPLE, GOOGLE, FITBIT
  accessToken  String? // Encrypted OAuth token
  refreshToken String? // Encrypted
  expiresAt    DateTime?
  lastSync     DateTime?
  isActive     Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([patientId, provider])
}

// Audit log for Chilean Law 20.584 compliance (Art. 14)
model AuditLog {
  id        String   @id @default(cuid())
  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull)

  userId     String // Who performed the action
  action     String // VIEW, CREATE, UPDATE, DELETE, EXPORT
  resource   String // PATIENT, APPOINTMENT, MEDICATION, etc.
  resourceId String? // ID of the resource
  details    String? // JSON with additional details
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([patientId])
  @@index([userId])
  @@index([createdAt])
}

model Appointment {
  id          String   @id @default(cuid())
  date        DateTime
  status      String   @default("PENDING") // PENDING, CONFIRMED, COMPLETED, CANCELLED
  serviceType String // KINESIOLOGY, ACUPUNCTURE, etc
  notes       String?

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  doctorId String?
  doctor   User?   @relation("DoctorAppointments", fields: [doctorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Professional Signature Model (Ley 20.584 compliance)
model ProfessionalSignature {
  id            String   @id @default(cuid())
  userId        String   // Professional who signs
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  signatureData String   // Base64 PNG of signature
  documentType  String   // APPOINTMENT, TREATMENT, PRESCRIPTION, MEDICAL_REPORT
  documentId    String   // ID of signed document
  
  // Metadata
  signedAt      DateTime @default(now())
  ipAddress     String?
  userAgent     String?
  
  // Hash for integrity verification
  documentHash  String?  // SHA-256 hash of document at time of signing
  
  @@index([userId])
  @@index([documentId])
  @@index([documentType])
}

// ============================================
// ACCOUNTING & INVOICING MODELS
// ============================================

// Invoices (Facturas/Boletas)
model Invoice {
  id              String   @id @default(cuid())
  invoiceNumber   String   @unique // Folio
  invoiceType     String   // BOLETA, FACTURA, NOTA_CREDITO, NOTA_DEBITO
  dteType         Int?     // 39, 33, 61, 56 (null if not sent to SII yet)
  
  // Client info
  patientId       String?
  patient         Patient? @relation(fields: [patientId], references: [id])
  clientRut       String?
  clientName      String?
  clientAddress   String?
  clientEmail     String?
  
  // Amounts (all in CLP)
  subtotal        Float    // Neto (sin IVA)
  tax             Float    // IVA (19%)
  total           Float    // Total (Neto + IVA)
  
  // Items
  items           InvoiceItem[]
  payments        Payment[]
  
  // DTE Info (SII Integration)
  dteXml          String?   // XML firmado
  dtePdfUrl       String?  // PDF URL
  siiStatus       String?  // ACCEPTED, REJECTED, PENDING
  siiTrackId      String?  // Track ID del SII
  siiResponse     String?   // Respuesta del SII
  
  // Payment
  paymentStatus   String   @default("PENDING") // PENDING, PARTIAL, PAID, OVERDUE, CANCELLED
  paymentMethod   String?  // CASH, CARD, TRANSFER, MERCADOPAGO
  paidAmount      Float    @default(0)
  paidAt          DateTime?
  
  // Metadata
  issuedAt        DateTime @default(now())
  dueDate         DateTime?
  notes           String?  
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([patientId])
  @@index([invoiceNumber])
  @@index([paymentStatus])
  @@index([issuedAt])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description String
  quantity    Float   @default(1)
  unitPrice   Float   // Precio unitario sin IVA
  discount    Float   @default(0)
  subtotal    Float   // (quantity * unitPrice) - discount
  
  // Service reference
  serviceType String?
  servicePriceId String?
  servicePrice   ServicePrice? @relation(fields: [servicePriceId], references: [id])
  
  createdAt   DateTime @default(now())
  
  @@index([invoiceId])
  @@index([servicePriceId])
}

// Expenses (Gastos)
model Expense {
  id            String   @id @default(cuid())
  
  description   String
  category      String   // SUPPLIES, RENT, UTILITIES, SALARIES, EQUIPMENT, MARKETING, OTHER
  amount        Float    // Monto en CLP
  
  // Tax deductible
  isDeductible  Boolean  @default(true)
  hasInvoice    Boolean  @default(false)
  supplierRut   String?
  supplierName  String?
  invoiceNumber String?
  
  // Payment
  paymentMethod String   // CASH, CARD, TRANSFER, CHECK
  paidAt        DateTime
  
  // Attachments
  receiptUrl    String?
  
  notes         String?  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([category])
  @@index([paidAt])
  @@index([isDeductible])
}

// Service Pricing (Precios de Servicios)
model ServicePrice {
  id          String   @id @default(cuid())
  
  name        String   @unique
  description String?  
  category    String?  // KINESIOLOGIA, ACUPUNTURA, MASAJES, EVALUACION, OTHER
  
  // Pricing (all in CLP)
  basePrice   Float    // Precio base sin IVA
  taxRate     Float    @default(0.19) // 19% IVA
  taxAmount   Float    // Monto del IVA
  finalPrice  Float    // Precio final con IVA
  
  // Duration
  durationMinutes Int? // Duración estimada en minutos
  
  // Status
  isActive    Boolean  @default(true)
  
  // Relations
  invoiceItems InvoiceItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive])
  @@index([category])
}

// Payment Records
model Payment {
  id            String   @id @default(cuid())
  
  invoiceId     String?
  invoice       Invoice? @relation(fields: [invoiceId], references: [id])
  
  amount        Float    // Monto en CLP
  method        String   // CASH, CARD, TRANSFER, MERCADOPAGO, CHECK
  reference     String?  // Número de transferencia, cheque, etc.
  
  // MercadoPago integration
  mpPaymentId   String?
  mpStatus      String?
  mpResponse    String?  
  
  // Metadata
  paidAt        DateTime @default(now())
  notes         String?
  
  createdAt     DateTime @default(now())
  
  @@index([invoiceId])
  @@index([paidAt])
  @@index([method])
}
