datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  role          String    @default("USER") // USER, ADMIN, DOCTOR, ASSISTANT
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  patient                  Patient?
  accounts                 Account[]
  sessions                 Session[]
  doctorAppointments       Appointment[] @relation("DoctorAppointments")
  professionalSignatures   ProfessionalSignature[]
}

model Patient {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal Info
  fullName   String
  phone      String?
  birthDate  DateTime
  occupation String?
  address    String?
  gender     String?

  // Additional Medical Info
  bloodType         String? // A+, B-, O+, etc.
  allergies         String? // JSON array of allergies (encrypted)
  chronicConditions String? // JSON array of chronic conditions (encrypted)
  emergencyContact  String? // JSON object with name, phone, relationship (encrypted)
  insuranceInfo     String? // JSON object with insurance details (encrypted)

  // Medical Data (Sensitive - will be encrypted)
  condition           String? // Encrypted
  anamnesis           String? // Encrypted
  surgicalHistory     String? // Encrypted
  pathologicalHistory String? // Encrypted
  diagnosis           String? // Encrypted
  treatmentPlan       String? // Encrypted
  evolutionNotes      String? // Encrypted

  // Privacy & Consent (Chilean Law 19.628 compliance)
  consentMedical        Boolean  @default(false)
  consentContact        Boolean  @default(false)
  consentDataProcessing Boolean  @default(false) // Art. 4 Ley 19.628
  consentDate           DateTime @default(now())
  consentUpdatedAt      DateTime @updatedAt

  // Soft Delete (Ley 19.628 Art. 14 - Derecho de Cancelaci√≥n)
  deletedAt DateTime?
  deletedBy String? // User ID who deleted

  // Relations
  appointments      Appointment[]
  medications       Medication[]
  treatments        MedicalTreatment[]
  healthMetrics     HealthMetric[]
  deviceConnections HealthDeviceConnection[]
  auditLogs         AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Medication tracking
model Medication {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  name         String
  dosage       String
  frequency    String
  startDate    DateTime
  endDate      DateTime?
  prescribedBy String? // Doctor name
  notes        String? // Encrypted
  isActive     Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Medical treatments (physiotherapy, acupuncture, etc.)
model MedicalTreatment {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  type        String // PHYSIOTHERAPY, ACUPUNCTURE, etc.
  description String?
  frequency   String? // e.g., "2 times per week"
  provider    String? // Clinic or professional name
  startDate   DateTime
  endDate     DateTime?
  progress    String? // JSON with progress notes (encrypted)
  isActive    Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Health metrics from devices or manual entry
model HealthMetric {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  type       String // STEPS, HEART_RATE, SLEEP, WEIGHT, BLOOD_PRESSURE, etc.
  value      Float
  unit       String // steps, bpm, hours, kg, mmHg, etc.
  source     String // APPLE_HEALTH, GOOGLE_FIT, FITBIT, MANUAL
  recordedAt DateTime
  notes      String?

  createdAt DateTime @default(now())
}

// Health device connections (Apple Health, Google Fit, etc.)
model HealthDeviceConnection {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  provider     String // APPLE, GOOGLE, FITBIT
  accessToken  String? // Encrypted OAuth token
  refreshToken String? // Encrypted
  expiresAt    DateTime?
  lastSync     DateTime?
  isActive     Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([patientId, provider])
}

// Audit log for Chilean Law 20.584 compliance (Art. 14)
model AuditLog {
  id        String   @id @default(cuid())
  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull)

  userId     String // Who performed the action
  action     String // VIEW, CREATE, UPDATE, DELETE, EXPORT
  resource   String // PATIENT, APPOINTMENT, MEDICATION, etc.
  resourceId String? // ID of the resource
  details    String? // JSON with additional details
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([patientId])
  @@index([userId])
  @@index([createdAt])
}

model Appointment {
  id          String   @id @default(cuid())
  date        DateTime
  status      String   @default("PENDING") // PENDING, CONFIRMED, COMPLETED, CANCELLED
  serviceType String // KINESIOLOGY, ACUPUNCTURE, etc
  notes       String?

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  doctorId String?
  doctor   User?   @relation("DoctorAppointments", fields: [doctorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

  @@unique([identifier, token])
}

// Professional Signature Model (Ley 20.584 compliance)
model ProfessionalSignature {
  id            String   @id @default(cuid())
  userId        String   // Professional who signs
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  signatureData String   // Base64 PNG of signature
  documentType  String   // APPOINTMENT, TREATMENT, PRESCRIPTION, MEDICAL_REPORT
  documentId    String   // ID of signed document
  
  // Metadata
  signedAt      DateTime @default(now())
  ipAddress     String?
  userAgent     String?
  
  // Hash for integrity verification
  documentHash  String?  // SHA-256 hash of document at time of signing
  
  @@index([userId])
  @@index([documentId])
  @@index([documentType])
}
